// src/rng.rs

// SAFETY: In the Ziggurat RNG, `rabs = (r >> 1) as i64` is always non-negative
// because `r` is a 52-bit unsigned value shifted right by 1. All subsequent casts
// of `rabs` to `usize` or `u64` are therefore safe.
#![allow(clippy::cast_sign_loss)]

use sha2::{Digest, Sha256};

/// RNG interface used by the VM (deterministic).
pub trait RngLike {
    fn next_f64(&mut self) -> f64;
    fn next_u64(&mut self) -> u64;
    fn reseed(&mut self, seed: u64);
}

/// Convert u64 to f64 in [0, 1) using Julia's method
/// Julia: (u64 >>> 11) * 2^(-53)
#[inline]
pub fn uint_to_float64_julia(u: u64) -> f64 {
    const SCALE: f64 = 1.0 / (1u64 << 53) as f64;
    (u >> 11) as f64 * SCALE
}

// -------------------------
// LehmerRNG (matching Julia's StableRNGs.jl)
// -------------------------
/// LehmerRNG is a Linear Congruential Generator that matches
/// Julia's StableRNGs.jl implementation (StableRNG = LehmerRNG)
/// Based on constants from Melissa E. O'Neill's implementation
#[derive(Debug, Clone)]
pub struct StableRng {
    state: u128,
}

impl StableRng {
    /// Create a new LehmerRNG with the given seed.
    /// Matches Julia's seeding: state = ((seed % UInt128) << 1) | 1
    pub fn new(seed: u64) -> Self {
        let state = ((seed as u128) << 1) | 1;
        Self { state }
    }

    #[inline]
    fn next_u64(&mut self) -> u64 {
        // Matches Julia's implementation:
        // rng.state *= 0x45a31efc5a35d971261fd0407a968add
        // return (rng.state >> 64) % UInt64
        const MULTIPLIER: u128 = 0x45a31efc5a35d971261fd0407a968add;
        self.state = self.state.wrapping_mul(MULTIPLIER);
        (self.state >> 64) as u64
    }

    #[inline]
    fn next_f64_inner(&mut self) -> f64 {
        // Match Julia's CloseOpen01 conversion exactly:
        // 1. Get UInt64
        // 2. Mask to 52 bits
        // 3. OR with 0x3ff0000000000000 (IEEE 754 for 1.0)
        // 4. Reinterpret as f64 and subtract 1.0
        let u64 = self.next_u64();
        let u52 = u64 & 0x000fffffffffffff;
        let bits = 0x3ff0000000000000u64 | u52;
        f64::from_bits(bits) - 1.0
    }
}

impl RngLike for StableRng {
    #[inline]
    fn next_f64(&mut self) -> f64 {
        self.next_f64_inner()
    }

    #[inline]
    fn next_u64(&mut self) -> u64 {
        // Matches Julia's implementation:
        // rng.state *= 0x45a31efc5a35d971261fd0407a968add
        // return (rng.state >> 64) % UInt64
        const MULTIPLIER: u128 = 0x45a31efc5a35d971261fd0407a968add;
        self.state = self.state.wrapping_mul(MULTIPLIER);
        (self.state >> 64) as u64
    }

    #[inline]
    fn reseed(&mut self, seed: u64) {
        self.state = ((seed as u128) << 1) | 1;
    }
}

// -------------------------
// Xoshiro256++ (Julia's default RNG)
// -------------------------
/// Xoshiro256++ RNG matching Julia's implementation
/// Based on julia/stdlib/Random/src/Xoshiro.jl
#[derive(Debug, Clone)]
pub struct Xoshiro {
    pub s0: u64,
    pub s1: u64,
    pub s2: u64,
    pub s3: u64,
    pub s4: u64, // internal splitmix state
}

impl Xoshiro {
    /// Create a new Xoshiro RNG with the given seed.
    /// Uses SHA2-256 hash to expand seed to 4x u64 (Julia-compatible).
    pub fn new(seed: u64) -> Self {
        // Hash the seed using SHA2-256 (matching Julia's hash_seed)
        let mut hasher = Sha256::new();
        let seed_bytes = seed.to_le_bytes();
        hasher.update(seed_bytes);
        let hash = hasher.finalize();

        // Extract 4 u64 values from the hash
        let s0 = u64::from_le_bytes(hash[0..8].try_into().unwrap());
        let s1 = u64::from_le_bytes(hash[8..16].try_into().unwrap());
        let s2 = u64::from_le_bytes(hash[16..24].try_into().unwrap());
        let s3 = u64::from_le_bytes(hash[24..32].try_into().unwrap());

        // Compute s4 as in Julia: 1*s0 + 3*s1 + 5*s2 + 7*s3
        let s4 = s0
            .wrapping_add(s1.wrapping_mul(3))
            .wrapping_add(s2.wrapping_mul(5))
            .wrapping_add(s3.wrapping_mul(7));

        Self { s0, s1, s2, s3, s4 }
    }

    /// Xoshiro256++ core algorithm
    #[inline]
    fn next_u64_inner(&mut self) -> u64 {
        // From julia/stdlib/Random/src/Xoshiro.jl lines 250-263
        let tmp = self.s0.wrapping_add(self.s3);
        let res = tmp.rotate_left(23).wrapping_add(self.s0);
        let t = self.s1 << 17;

        self.s2 ^= self.s0;
        self.s3 ^= self.s1;
        self.s1 ^= self.s2;
        self.s0 ^= self.s3;
        self.s2 ^= t;
        self.s3 = self.s3.rotate_left(45);

        res
    }
}

impl RngLike for Xoshiro {
    #[inline]
    fn next_f64(&mut self) -> f64 {
        uint_to_float64_julia(self.next_u64_inner())
    }

    #[inline]
    fn next_u64(&mut self) -> u64 {
        self.next_u64_inner()
    }

    #[inline]
    fn reseed(&mut self, seed: u64) {
        *self = Xoshiro::new(seed);
    }
}

// -------------------------
// RngInstance (unified RNG type)
// -------------------------
/// Unified RNG instance type for VM
#[derive(Debug, Clone)]
pub enum RngInstance {
    Stable(StableRng),
    Xoshiro(Xoshiro),
}

impl RngLike for RngInstance {
    #[inline]
    fn next_f64(&mut self) -> f64 {
        match self {
            RngInstance::Stable(rng) => rng.next_f64(),
            RngInstance::Xoshiro(rng) => rng.next_f64(),
        }
    }

    #[inline]
    fn next_u64(&mut self) -> u64 {
        match self {
            RngInstance::Stable(rng) => rng.next_u64(),
            RngInstance::Xoshiro(rng) => rng.next_u64(),
        }
    }

    #[inline]
    fn reseed(&mut self, seed: u64) {
        match self {
            RngInstance::Stable(rng) => rng.reseed(seed),
            RngInstance::Xoshiro(rng) => rng.reseed(seed),
        }
    }
}

// -------------------------
// randn (Ziggurat algorithm - Julia compatible)
// -------------------------
// From julia/stdlib/Random/src/normal.jl

/// Ziggurat constant: r = 3.6541528853610087963519472518
const ZIGGURAT_NOR_R: f64 = 3.654_152_885_361_009;
/// Ziggurat constant: 1/r
const ZIGGURAT_NOR_INV_R: f64 = 1.0 / ZIGGURAT_NOR_R;

/// Ziggurat ki table from Julia
const KI: [u64; 256] = [
    0x0007799ec012f7b2,
    0x0000000000000000,
    0x0006045f4c7de363,
    0x0006d1aa7d5ec0a5,
    0x000728fb3f60f777,
    0x0007592af4e9fbc0,
    0x000777a5c0bf655d,
    0x00078ca3857d2256,
    0x00079bf6b0ffe58b,
    0x0007a7a34ab092ad,
    0x0007b0d2f20dd1cb,
    0x0007b83d3aa9cb52,
    0x0007be597614224d,
    0x0007c3788631abe9,
    0x0007c7d32bc192ee,
    0x0007cb9263a6e86d,
    0x0007ced483edfa84,
    0x0007d1b07ac0fd39,
    0x0007d437ef2da5fc,
    0x0007d678b069aa6e,
    0x0007d87db38c5c87,
    0x0007da4fc6a9ba62,
    0x0007dbf611b37f3b,
    0x0007dd7674d0f286,
    0x0007ded5ce8205f6,
    0x0007e018307fb62b,
    0x0007e141081bd124,
    0x0007e2533d712de8,
    0x0007e3514bbd7718,
    0x0007e43d54944b52,
    0x0007e5192f25ef42,
    0x0007e5e67481118d,
    0x0007e6a6897c1ce2,
    0x0007e75aa6c7f64c,
    0x0007e803df8ee498,
    0x0007e8a326eb6272,
    0x0007e93954717a28,
    0x0007e9c727f8648f,
    0x0007ea4d4cc85a3c,
    0x0007eacc5c4907a9,
    0x0007eb44e0474cf6,
    0x0007ebb754e47419,
    0x0007ec242a3d8474,
    0x0007ec8bc5d69645,
    0x0007ecee83d3d6e9,
    0x0007ed4cb8082f45,
    0x0007eda6aee0170f,
    0x0007edfcae2dfe68,
    0x0007ee4ef5dccd3e,
    0x0007ee9dc08c394e,
    0x0007eee9441a17c7,
    0x0007ef31b21b4fb1,
    0x0007ef773846a8a7,
    0x0007efba00d35a17,
    0x0007effa32ccf69f,
    0x0007f037f25e1278,
    0x0007f0736112d12c,
    0x0007f0ac9e145c25,
    0x0007f0e3c65e1fcc,
    0x0007f118f4ed8e54,
    0x0007f14c42ed0dc8,
    0x0007f17dc7daa0c3,
    0x0007f1ad99aac6a5,
    0x0007f1dbcce80015,
    0x0007f20874cf56bf,
    0x0007f233a36a3b9a,
    0x0007f25d69a604ad,
    0x0007f285d7694a92,
    0x0007f2acfba75e3b,
    0x0007f2d2e4720909,
    0x0007f2f79f09c344,
    0x0007f31b37ec883b,
    0x0007f33dbae36abc,
    0x0007f35f330f08d5,
    0x0007f37faaf2fa79,
    0x0007f39f2c805380,
    0x0007f3bdc11f4f1c,
    0x0007f3db71b83850,
    0x0007f3f846bba121,
    0x0007f4144829f846,
    0x0007f42f7d9a8b9d,
    0x0007f449ee420432,
    0x0007f463a0f8675e,
    0x0007f47c9c3ea77b,
    0x0007f494e643cd8e,
    0x0007f4ac84e9c475,
    0x0007f4c37dc9cd50,
    0x0007f4d9d638a432,
    0x0007f4ef934a5b6a,
    0x0007f504b9d5f33d,
    0x0007f5194e78b352,
    0x0007f52d55994a96,
    0x0007f540d36aba0c,
    0x0007f553cbef0e77,
    0x0007f56642f9ec8f,
    0x0007f5783c32f31e,
    0x0007f589bb17f609,
    0x0007f59ac2ff1525,
    0x0007f5ab5718b15a,
    0x0007f5bb7a71427c,
    0x0007f5cb2ff31009,
    0x0007f5da7a67cebe,
    0x0007f5e95c7a24e7,
    0x0007f5f7d8b7171e,
    0x0007f605f18f5ef4,
    0x0007f613a958ad0a,
    0x0007f621024ed7e9,
    0x0007f62dfe94f8cb,
    0x0007f63aa036777a,
    0x0007f646e928065a,
    0x0007f652db488f88,
    0x0007f65e786213ff,
    0x0007f669c22a7d8a,
    0x0007f674ba446459,
    0x0007f67f623fc8db,
    0x0007f689bb9ac294,
    0x0007f693c7c22481,
    0x0007f69d881217a6,
    0x0007f6a6fdd6ac36,
    0x0007f6b02a4c61ee,
    0x0007f6b90ea0a7f4,
    0x0007f6c1abf254c0,
    0x0007f6ca03521664,
    0x0007f6d215c2db82,
    0x0007f6d9e43a3559,
    0x0007f6e16fa0b329,
    0x0007f6e8b8d23729,
    0x0007f6efc09e4569,
    0x0007f6f687c84cbf,
    0x0007f6fd0f07ea09,
    0x0007f703570925e2,
    0x0007f709606cad03,
    0x0007f70f2bc8036f,
    0x0007f714b9a5b292,
    0x0007f71a0a85725d,
    0x0007f71f1edc4d9e,
    0x0007f723f714c179,
    0x0007f728938ed843,
    0x0007f72cf4a03fa0,
    0x0007f7311a945a16,
    0x0007f73505ac4bf8,
    0x0007f738b61f03bd,
    0x0007f73c2c193dc0,
    0x0007f73f67bd835c,
    0x0007f74269242559,
    0x0007f745305b31a1,
    0x0007f747bd666428,
    0x0007f74a103f12ed,
    0x0007f74c28d414f5,
    0x0007f74e0709a42d,
    0x0007f74faab939f9,
    0x0007f75113b16657,
    0x0007f75241b5a155,
    0x0007f753347e16b8,
    0x0007f753ebb76b7c,
    0x0007f75467027d05,
    0x0007f754a5f4199d,
    0x0007f754a814b207,
    0x0007f7546ce003ae,
    0x0007f753f3c4bb29,
    0x0007f7533c240e92,
    0x0007f75245514f41,
    0x0007f7510e91726c,
    0x0007f74f971a9012,
    0x0007f74dde135797,
    0x0007f74be2927971,
    0x0007f749a39e051c,
    0x0007f747202aba8a,
    0x0007f744571b4e3c,
    0x0007f741473f9efe,
    0x0007f73def53dc43,
    0x0007f73a4dff9bff,
    0x0007f73661d4deaf,
    0x0007f732294f003f,
    0x0007f72da2d19444,
    0x0007f728cca72bda,
    0x0007f723a5000367,
    0x0007f71e29f09627,
    0x0007f7185970156b,
    0x0007f7123156c102,
    0x0007f70baf5c1e2c,
    0x0007f704d1150a23,
    0x0007f6fd93f1a4e5,
    0x0007f6f5f53b10b6,
    0x0007f6edf211023e,
    0x0007f6e587671ce9,
    0x0007f6dcb2021679,
    0x0007f6d36e749c64,
    0x0007f6c9b91bf4c6,
    0x0007f6bf8e1c541b,
    0x0007f6b4e95ce015,
    0x0007f6a9c68356ff,
    0x0007f69e20ef5211,
    0x0007f691f3b517eb,
    0x0007f6853997f321,
    0x0007f677ed03ff19,
    0x0007f66a08075bdc,
    0x0007f65b844ab75a,
    0x0007f64c5b091860,
    0x0007f63c8506d4bc,
    0x0007f62bfa8798fe,
    0x0007f61ab34364b0,
    0x0007f608a65a599a,
    0x0007f5f5ca4737e8,
    0x0007f5e214d05b48,
    0x0007f5cd7af7066e,
    0x0007f5b7f0e4c2a1,
    0x0007f5a169d68fcf,
    0x0007f589d80596a5,
    0x0007f5712c8d0174,
    0x0007f557574c912b,
    0x0007f53c46c77193,
    0x0007f51fe7feb9f2,
    0x0007f5022646ecfb,
    0x0007f4e2eb17ab1d,
    0x0007f4c21dd4a3d1,
    0x0007f49fa38ea394,
    0x0007f47b5ebb62eb,
    0x0007f4552ee27473,
    0x0007f42cf03d58f5,
    0x0007f4027b48549f,
    0x0007f3d5a44119df,
    0x0007f3a63a8fb552,
    0x0007f37408155100,
    0x0007f33ed05b55ec,
    0x0007f3064f9c183e,
    0x0007f2ca399c7ba1,
    0x0007f28a384bb940,
    0x0007f245ea1b7a2b,
    0x0007f1fcdffe8f1b,
    0x0007f1ae9af758cd,
    0x0007f15a8917f27e,
    0x0007f10001ccaaab,
    0x0007f09e413c418a,
    0x0007f034627733d7,
    0x0007efc15815b8d5,
    0x0007ef43e2bf7f55,
    0x0007eeba84e31dfe,
    0x0007ee237294df89,
    0x0007ed7c7c170141,
    0x0007ecc2f0d95d3a,
    0x0007ebf377a46782,
    0x0007eb09d6deb285,
    0x0007ea00a4f17808,
    0x0007e8d0d3da63d6,
    0x0007e771023b0fcf,
    0x0007e5d46c2f08d8,
    0x0007e3e937669691,
    0x0007e195978f1176,
    0x0007deb2c0e05c1c,
    0x0007db0362002a19,
    0x0007d6202c151439,
    0x0007cf4b8f00a2cb,
    0x0007c4fd24520efd,
    0x0007b362fbf81816,
    0x00078d2d25998e24,
];

/// Ziggurat wi table from Julia
const WI: [f64; 256] = [
    1.736_725_412_160_263e-15,
    9.558_660_351_455_634e-17,
    1.2708704834810623e-16,
    1.4909740962495474e-16,
    1.6658733631586268e-16,
    1.8136120810119029e-16,
    1.9429720153135588e-16,
    2.0589500628482093e-16,
    2.1646860576895422e-16,
    2.2622940392218116e-16,
    2.353_271_891_404_589e-16,
    2.438_723_455_742_877e-16,
    2.5194879829274225e-16,
    2.5962199772528103e-16,
    2.6694407473648285e-16,
    2.7395729685142446e-16,
    2.8069646002484804e-16,
    2.871_905_890_411_393e-16,
    2.9346417484728883e-16,
    2.9953809336782113e-16,
    3.054_303_000_719_244e-16,
    3.111_563_633_892_157e-16,
    3.1672988018581815e-16,
    3.2216280350549905e-16,
    3.274_657_040_793_975e-16,
    3.326_479_811_684_171e-16,
    3.377_180_341_735_323e-16,
    3.4268340353119356e-16,
    3.475_508_873_172_976e-16,
    3.523_266_384_600_203e-16,
    3.5701624633953494e-16,
    3.616_248_057_159_834e-16,
    3.661_569_752_965_354e-16,
    3.7061702777236077e-16,
    3.750_088_927_874_78e-16,
    3.7933619401549554e-16,
    3.836_022_812_967_728e-16,
    3.8781025861250247e-16,
    3.919_630_085_325_768e-16,
    3.9606321366256378e-16,
    4.001_133_755_254_669e-16,
    4.041_158_312_414_333e-16,
    4.080_727_683_096_045e-16,
    4.119_862_377_480_744e-16,
    4.1585816580828064e-16,
    4.1969036444740733e-16,
    4.234_845_407_152_071e-16,
    4.272_423_051_889_976e-16,
    4.309_651_795_716_294e-16,
    4.346_546_035_512_876e-16,
    4.383_119_410_085_457e-16,
    4.4193848564470665e-16,
    4.455_354_660_957_914e-16,
    4.491_040_505_882_875e-16,
    4.526_453_511_857_14e-16,
    4.561_604_276_690_038e-16,
    4.596_502_910_884_941e-16,
    4.631_159_070_208_165e-16,
    4.665_581_985_600_875e-16,
    4.699_780_490_694_195e-16,
    4.733_763_047_158_324e-16,
    4.767_537_768_090_853e-16,
    4.8011124396270155e-16,
    4.834_494_540_935_008e-16,
    4.867_691_262_742_209e-16,
    4.900_709_524_522_994e-16,
    4.933_555_990_465_414e-16,
    4.966_237_084_322_178e-16,
    4.998_759_003_240_909e-16,
    5.031_127_730_659_319e-16,
    5.0633490483427195e-16,
    5.095_428_547_633_892e-16,
    5.127_371_639_978_797e-16,
    5.159_183_566_785_736e-16,
    5.190_869_408_670_343e-16,
    5.222_434_094_134_042e-16,
    5.253_882_407_719_454e-16,
    5.285_218_997_682_382e-16,
    5.316_448_383_216_618e-16,
    5.347_574_961_264_73e-16,
    5.378_603_012_945_235e-16,
    5.409_536_709_623_993e-16,
    5.440_380_118_655_467e-16,
    5.471_137_208_817_361e-16,
    5.501_811_855_460_336e-16,
    5.532_407_845_392_784e-16,
    5.562_928_881_519_09e-16,
    5.593_378_587_248_462e-16,
    5.623_760_510_690_043e-16,
    5.654_078_128_648_96e-16,
    5.684_334_850_436_814e-16,
    5.714_534_021_509_204e-16,
    5.744_678_926_941_961e-16,
    5.774_772_794_756_965e-16,
    5.804_818_799_107_686e-16,
    5.834_820_063_333_892e-16,
    5.864_779_662_894_365e-16,
    5.894_700_628_185_872e-16,
    5.924_585_947_256_134e-16,
    5.954_438_568_418_06e-16,
    5.984_261_402_772_028e-16,
    6.014_057_326_642_664e-16,
    6.043_829_183_936_125e-16,
    6.073_579_788_423_606e-16,
    6.103_311_925_956_439e-16,
    6.133_028_356_617_911e-16,
    6.162_731_816_816_596e-16,
    6.192_425_021_325_847e-16,
    6.222_110_665_273_788e-16,
    6.251_791_426_088e-16,
    6.281_469_965_398_895e-16,
    6.311_148_930_905_604e-16,
    6.340_830_958_208_06e-16,
    6.370_518_672_608_815e-16,
    6.400_214_690_888_025e-16,
    6.429_921_623_054_896e-16,
    6.459_642_074_078_832e-16,
    6.489_378_645_603_397e-16,
    6.519_133_937_646_159e-16,
    6.548_910_550_287_415e-16,
    6.578_711_085_350_741e-16,
    6.608_538_148_078_259e-16,
    6.638_394_348_803_506e-16,
    6.668_282_304_624_746e-16,
    6.698_204_641_081_558e-16,
    6.728_163_993_837_531e-16,
    6.758_163_010_371_901e-16,
    6.788_204_351_682_98e-16,
    6.818_290_694_006_254e-16,
    6.848_424_730_550_038e-16,
    6.878_609_173_251_664e-16,
    6.908_846_754_557_169e-16,
    6.939_140_229_227_569e-16,
    6.969_492_376_174_829e-16,
    6.999_906_000_330_764e-16,
    7.030_383_934_552_151e-16,
    7.060_929_041_565_482e-16,
    7.091_544_215_954_873e-16,
    7.122_232_386_196_779e-16,
    7.152_996_516_745_303e-16,
    7.183_839_610_172_063e-16,
    7.214_764_709_364_707e-16,
    7.245_774_899_788_387e-16,
    7.276_873_311_814_693e-16,
    7.308_063_123_122_743e-16,
    7.339_347_561_177_405e-16,
    7.370_729_905_789_831e-16,
    7.402_213_491_765_8e-16,
    7.433_801_711_647_648e-16,
    7.465_498_018_555_889e-16,
    7.497_305_929_136_979e-16,
    7.529_229_026_624_058e-16,
    7.561_270_964_017_922e-16,
    7.5934354673958895e-16,
    7.625_726_339_356_756e-16,
    7.658_147_462_610_487e-16,
    7.690_702_803_721_919e-16,
    7.723_396_417_018_299e-16,
    7.756_232_448_671_174e-16,
    7.789_215_140_963_852e-16,
    7.822_348_836_756_411e-16,
    7.855_637_984_161_084e-16,
    7.889_087_141_441_755e-16,
    7.922_700_982_152_271e-16,
    7.956_484_300_529_366e-16,
    7.990_442_017_157_13e-16,
    8.024_579_184_921_259e-16,
    8.058_900_995_272_657e-16,
    8.093_412_784_821_501e-16,
    8.128_120_042_284_501e-16,
    8.163_028_415_809_877e-16,
    8.198_143_720_706_533e-16,
    8.233_471_947_606_05e-16,
    8.269_019_271_088_47e-16,
    8.304_792_058_805_374e-16,
    8.340_796_881_136_629e-16,
    8.377_040_521_420_222e-16,
    8.413_529_986_798_028e-16,
    8.450_272_519_724_097e-16,
    8.487_275_610_186_155e-16,
    8.524_547_008_695_596e-16,
    8.562_094_740_106_233e-16,
    8.599_927_118_327_665e-16,
    8.638_052_762_005_259e-16,
    8.676_480_611_245_582e-16,
    8.715_219_945_473_698e-16,
    8.754_280_402_517_175e-16,
    8.793_671_999_021_043e-16,
    8.833_405_152_308_408e-16,
    8.873_490_703_813_135e-16,
    8.913_939_944_224_086e-16,
    8.954_764_640_495_068e-16,
    8.995_977_064_891_1e-16,
    9.037_590_026_260_118e-16,
    9.079_616_903_740_068e-16,
    9.122_071_683_134_846e-16,
    9.164_968_996_219_135e-16,
    9.208_324_163_262_308e-16,
    9.252_153_239_095_693e-16,
    9.296_473_063_086_417e-16,
    9.341_301_313_425_265e-16,
    9.386_656_566_186_66e-16,
    9.432_558_359_676_707e-16,
    9.479_027_264_651_738e-16,
    9.526_084_961_066_279e-16,
    9.573_754_322_097_45e-16,
    9.622_059_506_294_838e-16,
    9.671_026_058_823_054e-16,
    9.720_681_022_901_626e-16,
    9.771_053_062_707_209e-16,
    9.822_172_599_190_541e-16,
    9.874_071_960_480_671e-16,
    9.926_785_548_807_976e-16,
    9.980_350_026_183_645e-16,
    1.003_480_452_143_618e-15,
    1.0090190861637457e-15,
    1.0146553831467086e-15,
    1.0203941464683124e-15,
    1.0262405372613567e-15,
    1.0322001115486456e-15,
    1.038_278_862_351_54e-15,
    1.044_483_267_600_047e-15,
    1.0508203448355195e-15,
    1.057_297_713_900_989e-15,
    1.063_923_669_067_68e-15,
    1.0707072623632994e-15,
    1.0776584002668106e-15,
    1.0847879564403425e-15,
    1.0921079038149563e-15,
    1.0996314701785628e-15,
    1.1073733224935752e-15,
    1.1153497865853155e-15,
    1.1235791107110833e-15,
    1.1320817840164846e-15,
    1.140_880_924_258_278e-15,
    1.1500027537839792e-15,
    1.159_477_189_144_919e-15,
    1.169_338_578_691_096e-15,
    1.179_626_635_295_58e-15,
    1.190_387_629_928_289e-15,
    1.2016759392543819e-15,
    1.2135560818666897e-15,
    1.2261054417450561e-15,
    1.2394179789163251e-15,
    1.2536093926602567e-15,
    1.268_824_481_425_501e-15,
    1.2852479319096109e-15,
    1.3031206634689985e-15,
    1.3227655770195326e-15,
    1.3446300925011171e-15,
    1.3693606835128518e-15,
    1.397_943_667_277_524e-15,
    1.4319989869661328e-15,
    1.4744848603597596e-15,
    1.5317872741611144e-15,
    1.6227698675312968e-15,
];

/// Ziggurat fi table from Julia
const FI: [f64; 256] = [
    1.0,
    9.771_017_012_676_708e-1,
    9.598_790_918_001_06e-1,
    9.451_989_534_422_991e-1,
    9.320_600_759_592_299e-1,
    9.199_915_050_393_465e-1,
    9.087_264_400_521_303e-1,
    8.980_959_218_983_43e-1,
    8.879_846_607_558_328e-1,
    8.783_096_558_089_168e-1,
    8.690_086_880_368_565e-1,
    8.600_336_211_963_311e-1,
    8.513_462_584_586_775e-1,
    8.429_156_531_122_037e-1,
    8.347_162_929_868_83e-1,
    8.267_268_339_462_209e-1,
    8.189_291_916_037_019e-1,
    8.113_078_743_126_557e-1,
    8.038_494_831_709_638e-1,
    7.965_423_304_229_584e-1,
    7.893_761_435_660_24e-1,
    7.823_418_326_548_02e-1,
    7.754_313_049_811_866e-1,
    7.686_373_157_984_857e-1,
    7.619_533_468_367_948e-1,
    7.553_735_065_070_957e-1,
    7.488_924_472_191_564e-1,
    7.425_052_963_401_506e-1,
    7.362_075_981_268_621e-1,
    7.299_952_645_614_757e-1,
    7.238_645_334_686_297e-1,
    7.178_119_326_307_215e-1,
    7.118_342_488_782_48e-1,
    7.059_285_013_327_538e-1,
    7.000_919_181_365_112e-1,
    6.943_219_161_261_163e-1,
    6.886_160_830_046_714e-1,
    6.829_721_616_449_943e-1,
    6.773_880_362_187_731e-1,
    6.718_617_198_970_817e-1,
    6.663_913_439_087_498e-1,
    6.609_751_477_766_628e-1,
    6.556_114_705_796_969e-1,
    6.502_987_431_108_164e-1,
    6.450_354_808_208_22e-1,
    6.398_202_774_530_561e-1,
    6.346_517_992_876_233e-1,
    6.295_287_799_248_362e-1,
    6.244_500_155_470_261e-1,
    6.194_143_606_058_34e-1,
    6.144_207_238_889_134e-1,
    6.094_680_649_257_731e-1,
    6.045_553_906_974_673e-1,
    5.996_817_526_191_248e-1,
    5.948_462_437_679_869e-1,
    5.900_479_963_328_255e-1,
    5.852_861_792_633_709e-1,
    5.805_599_961_007_903e-1,
    5.758_686_829_723_532e-1,
    5.712_115_067_352_527e-1,
    5.665_877_632_561_639e-1,
    5.619_967_758_145_239e-1,
    5.574_378_936_187_655e-1,
    5.529_104_904_258_318e-1,
    5.484_139_632_552_654e-1,
    5.439_477_311_900_258e-1,
    5.395_112_342_569_516e-1,
    5.351_039_323_804_572e-1,
    5.307_253_044_036_615e-1,
    5.263_748_471_716_84e-1,
    5.220_520_746_723_214e-1,
    5.177_565_172_297_559e-1,
    5.134_877_207_473_265e-1,
    5.092_452_459_957_476e-1,
    5.050_286_679_434_679e-1,
    5.008_375_751_261_483e-1,
    4.966_715_690_524_893e-1,
    4.9253026364386815e-01,
    4.884_132_847_054_576e-1,
    4.843_202_694_266_829e-1,
    4.802_508_659_090_464e-1,
    4.762_047_327_195_055e-1,
    4.7218153846772976e-01,
    4.681_809_614_056_932e-1,
    4.642_026_890_481_739e-1,
    4.602_464_178_128_425e-1,
    4.563_118_526_787_161e-1,
    4.5239870686184824e-01,
    4.4850670150720273e-01,
    4.446_355_653_957_391e-1,
    4.4078503466580377e-01,
    4.3695485254798533e-01,
    4.331_447_691_126_521e-1,
    4.2935454102944126e-01,
    4.255_839_313_380_218e-1,
    4.2183270922949573e-01,
    4.1810064983784795e-01,
    4.143_875_340_408_909e-1,
    4.106_931_482_701_88e-1,
    4.0701728432947315e-01,
    4.033_597_392_211_143e-1,
    3.997_203_149_801_97e-1,
    3.9609881851583223e-01,
    3.924_950_614_593_154e-1,
    3.8890886001878855e-01,
    3.8534003484007706e-01,
    3.8178841087339344e-01,
    3.7825381724561896e-01,
    3.7473608713789086e-01,
    3.712_350_576_682_392e-1,
    3.6775056977903225e-01,
    3.642_824_681_290_037e-1,
    3.6083060098964775e-01,
    3.573_948_201_457_802e-1,
    3.5397498080007656e-01,
    3.505_709_414_814_059e-1,
    3.471_825_639_567_935e-1,
    3.4380971314685055e-01,
    3.4045225704452164e-01,
    3.371_100_666_370_059e-1,
    3.3378301583071823e-01,
    3.304_709_813_791_634e-1,
    3.271_738_428_136_013e-1,
    3.2389148237639104e-01,
    3.206_237_849_569_053e-1,
    3.173_706_380_299_135e-1,
    3.1413193159633707e-01,
    3.1090755812628634e-01,
    3.076_974_125_042_919e-1,
    3.045_013_919_766_498e-1,
    3.013_193_961_008_029e-1,
    2.981_513_266_966_853e-1,
    2.9499708779996164e-01,
    2.918_565_856_170_95e-1,
    2.887_297_284_821_827e-1,
    2.856_164_268_155_016e-1,
    2.825_165_930_837_074e-1,
    2.794_301_417_616_377e-1,
    2.763_569_892_956_681e-1,
    2.732_970_540_685_769e-1,
    2.702_502_563_658_752e-1,
    2.6721651834356114e-01,
    2.641_957_639_972_608e-1,
    2.611_879_191_327_208e-1,
    2.581_929_113_376_189e-1,
    2.552_106_699_546_617e-1,
    2.522_411_260_559_419e-1,
    2.4928421241852824e-01,
    2.4633986350126363e-01,
    2.4340801542275012e-01,
    2.404_886_059_405_004e-1,
    2.3758157443123795e-01,
    2.346_868_618_723_299e-1,
    2.3180441082433859e-01,
    2.2893416541468023e-01,
    2.260_760_713_223_802e-1,
    2.2323007576391746e-01,
    2.2039612748015194e-01,
    2.1757417672433113e-01,
    2.1476417525117358e-01,
    2.1196607630703015e-01,
    2.091_798_346_211_25e-1,
    2.0640540639788071e-01,
    2.0364274931033485e-01,
    2.0089182249465656e-01,
    1.981_525_865_457_751e-1,
    1.9542500351413428e-01,
    1.9270903690358912e-01,
    1.9000465167046496e-01,
    1.8731181422380025e-01,
    1.8463049242679927e-01,
    1.8196065559952254e-01,
    1.7930227452284767e-01,
    1.766_553_214_437_35e-1,
    1.7401977008183875e-01,
    1.7139559563750595e-01,
    1.687_827_748_012_115e-1,
    1.6618128576448205e-01,
    1.635_911_082_323_657e-1,
    1.6101222343751107e-01,
    1.584_446_141_559_243e-1,
    1.558_882_647_244_792e-1,
    1.5334316106026283e-01,
    1.5080929068184568e-01,
    1.4828664273257453e-01,
    1.4577520800599403e-01,
    1.432_749_789_735_134e-1,
    1.407_859_498_144_447e-1,
    1.383_081_164_485_507e-1,
    1.3584147657125373e-01,
    1.3338602969166913e-01,
    1.309_417_771_736_443e-1,
    1.2850872227999952e-01,
    1.2608687022018586e-01,
    1.2367622820159654e-01,
    1.2127680548479021e-01,
    1.1888861344290998e-01,
    1.165_116_656_256_108e-1,
    1.1414597782783835e-01,
    1.117_915_681_638_38e-1,
    1.0944845714681163e-01,
    1.0711666777468364e-01,
    1.047_962_256_224_869e-1,
    1.0248715894193508e-01,
    1.0018949876880981e-01,
    9.790_327_903_886_228e-2,
    9.562_853_671_300_882e-2,
    9.336_531_191_269_086e-2,
    9.111_364_806_637_363e-2,
    8.887_359_206_827_579e-2,
    8.664_519_445_055_796e-2,
    8.442_850_957_035_337e-2,
    8.222_359_581_320_286e-2,
    8.003_051_581_466_306e-2,
    7.784_933_670_209_604e-2,
    7.568_013_035_892_707e-2,
    7.352_297_371_398_127e-2,
    7.137_794_905_889_037e-2,
    6.924_514_439_700_677e-2,
    6.712_465_382_778_85e-2,
    6.501_657_797_124_284e-2,
    6.292_102_443_775_811e-2,
    6.0838108349539864e-02,
    5.876_795_292_093_376e-2,
    5.671_069_010_620_29e-2,
    5.4666461324888914e-02,
    5.2635418276792176e-02,
    5.061_772_386_094_776e-2,
    4.861_355_321_586_852e-2,
    4.662_309_490_193_037e-2,
    4.464_655_225_129_444e-2,
    4.268_414_491_647_443e-2,
    4.073_611_065_594_093e-2,
    3.880_270_740_452_611e-2,
    3.6884215688567284e-02,
    3.4980941461716084e-02,
    3.309_321_945_857_852e-2,
    3.1221417191920245e-02,
    2.9365939758133314e-02,
    2.7527235669603082e-02,
    2.5705804008548896e-02,
    2.3902203305795882e-02,
    2.2117062707308864e-02,
    2.0351096230044517e-02,
    1.8605121275724643e-02,
    1.6880083152543166e-02,
    1.5177088307935325e-02,
    1.349_745_060_173_988e-2,
    1.1842757857907888e-02,
    1.0214971439701471e-02,
    8.616_582_769_398_732e-3,
    7.050_875_471_373_227e-3,
    5.522_403_299_250_997e-3,
    4.0379725933630305e-03,
    2.6090727461021627e-03,
    1.2602859304985975e-03,
];

/// Generate a standard normal random number using Ziggurat algorithm (Julia compatible)
/// From julia/stdlib/Random/src/normal.jl
pub fn randn<R: RngLike>(rng: &mut R) -> f64 {
    // Get a 52-bit random number (matching Julia's UInt52())
    let r = rng.next_u64() & 0x000fffffffffffff;

    // One bit for the sign
    let rabs = (r >> 1) as i64;
    let idx = (rabs & 0xFF) as usize;

    // x = ifelse(r % Bool, -rabs, rabs) * wi[idx+1]
    let x = if r & 1 == 1 {
        -(rabs as f64) * WI[idx]
    } else {
        (rabs as f64) * WI[idx]
    };

    // 99.3% of the time we return here on first try
    if (rabs as u64) < KI[idx] {
        return x;
    }

    // Fall back to the unlikely path
    randn_unlikely(rng, idx, rabs, x)
}

/// Handle unlikely paths in the Ziggurat algorithm
#[inline(never)]
fn randn_unlikely<R: RngLike>(rng: &mut R, idx: usize, rabs: i64, x: f64) -> f64 {
    if idx == 0 {
        // Tail: generate from tail of normal distribution
        loop {
            // xx = -ziggurat_nor_inv_r * log1p(-rand(rng))
            let xx = -ZIGGURAT_NOR_INV_R * (-rng.next_f64()).ln_1p();
            // yy = -log1p(-rand(rng))
            let yy = -(-rng.next_f64()).ln_1p();
            // yy + yy > xx * xx
            if yy + yy > xx * xx {
                // return (rabs >> 8) % Bool ? -ziggurat_nor_r - xx : ziggurat_nor_r + xx
                return if ((rabs >> 8) & 1) == 1 {
                    -ZIGGURAT_NOR_R - xx
                } else {
                    ZIGGURAT_NOR_R + xx
                };
            }
        }
    } else if (FI[idx - 1] - FI[idx]) * rng.next_f64() + FI[idx] < (-0.5 * x * x).exp() {
        // Return from the triangular area
        x
    } else {
        // Retry
        randn(rng)
    }
}

/// Generate a standard normal complex random number
/// Julia: sqrt(0.5) * (randn() + im * randn())
pub fn randn_complex<R: RngLike>(rng: &mut R) -> (f64, f64) {
    (
        std::f64::consts::FRAC_1_SQRT_2 * randn(rng),
        std::f64::consts::FRAC_1_SQRT_2 * randn(rng),
    )
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_rng_deterministic() {
        // Same seed should produce same sequence
        let mut rng1 = StableRng::new(42);
        let mut rng2 = StableRng::new(42);

        for _ in 0..100 {
            assert_eq!(rng1.next_f64(), rng2.next_f64());
        }
    }

    #[test]
    fn test_rng_different_seeds() {
        // Different seeds should produce different sequences
        let mut rng1 = StableRng::new(42);
        let mut rng2 = StableRng::new(123);

        // At least one of the first 10 values should differ
        let mut all_same = true;
        for _ in 0..10 {
            if rng1.next_f64() != rng2.next_f64() {
                all_same = false;
                break;
            }
        }
        assert!(!all_same);
    }

    #[test]
    fn test_rng_range() {
        // Values should be in [0, 1)
        let mut rng = StableRng::new(12345);
        for _ in 0..1000 {
            let v = rng.next_f64();
            assert!(v >= 0.0, "Value {} is less than 0", v);
            assert!(v < 1.0, "Value {} is >= 1", v);
        }
    }

    #[test]
    fn test_rng_seed_zero() {
        // Seed 0 should work
        let mut rng = StableRng::new(0);
        let v = rng.next_f64();
        assert!((0.0..1.0).contains(&v));
    }

    #[test]
    fn test_rng_seed_max() {
        // Max seed should work
        let mut rng = StableRng::new(u64::MAX);
        let v = rng.next_f64();
        assert!((0.0..1.0).contains(&v));
    }

    #[test]
    fn test_randn_julia_compatibility() {
        // Test randn values against Julia's StableRNGs.jl output
        // Julia code:
        //   using StableRNGs
        //   rng = StableRNG(42)
        //   for i in 1:10; println(randn(rng)); end
        let mut rng = StableRng::new(42);

        // Expected values from Julia StableRNG(42)
        let julia_values = [
            -0.6702516921145671,
            0.4471218424633827,
            1.3736306979834252,
            1.3095394956381083,
            0.12607002180931043,
            0.683947930996541,
            -1.019202452456547,
            -0.7935128416361353,
            1.7747246334368165,
            1.2973461452176338,
        ];

        for (i, &expected) in julia_values.iter().enumerate() {
            let actual = randn(&mut rng);
            let diff = (actual - expected).abs();
            assert!(
                diff < 1e-14,
                "randn {} mismatch: expected {}, got {}, diff {}",
                i + 1,
                expected,
                actual,
                diff
            );
        }
    }

    #[test]
    fn test_randn_distribution() {
        // Statistical test: randn should produce values with mean ~0 and std ~1
        let mut rng = StableRng::new(12345);
        let n = 10000;
        let mut sum = 0.0;
        let mut sum_sq = 0.0;

        for _ in 0..n {
            let v = randn(&mut rng);
            sum += v;
            sum_sq += v * v;
        }

        let mean = sum / n as f64;
        let variance = sum_sq / n as f64 - mean * mean;
        let std = variance.sqrt();

        // Mean should be close to 0 (within 0.05)
        assert!(mean.abs() < 0.05, "Mean {} is too far from 0", mean);
        // Std should be close to 1 (within 0.1)
        assert!((std - 1.0).abs() < 0.1, "Std {} is too far from 1", std);
    }
}
